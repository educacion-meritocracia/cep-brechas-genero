---
title: "issp-prod"
date: "`r format(Sys.time(), '%A %d %B %Y %X')`"
output:
  bookdown::html_document2:
    number_sections: true
    toc: true
    toc_float:
        collapsed: false
    toc_depth: 2
    code_folding: "hide"
editor_options:
  chunk_output_type: console
---

# Cargar paquetes

```{r}
knitr::opts_chunk$set(warning = FALSE,
                      message = FALSE, 
                      cache = FALSE,
                      results = "hold")
options(scipen=999)
if (!require("pacman")) install.packages("pacman") # instalar pacman
pacman::p_load(dplyr, tidyr, haven, stargazer, sjmisc, sjPlot, sjlabelled, tidyverse, summarytools, ggplot2, ggpubr, texreg, webshot, survey, srvyr, ggrepel, kableExtra, ggpattern)
```

# cargar bases de datos Chile

```{r}
load("input/proc/chile_1999.RData")
load("input/proc/chile_2009.RData")
load("input/proc/chile_2019.RData")
```

## Ponderadores

* 1999
```{r}
chile_1999$sexo <- factor(chile_1999$sex, labels = c("Hombre", "Mujer"))
chile_1999 <- chile_1999 %>% mutate_at(vars(starts_with(c("V", "brecha"))), ~(as.numeric(.))) 

chile_1999_exp <- chile_1999 %>% as_survey_design(ids = 1,
                                                      weights = WEIGHT)
```

* 2009
```{r}
chile_2009$sexo <- factor(chile_2009$sex, labels = c("Hombre", "Mujer"))
chile_2009 <- chile_2009 %>% mutate_at(vars(starts_with(c("V", "brecha"))), ~(as.numeric(.))) 

chile_2009_exp <- chile_2009 %>% as_survey_design(ids = 1,
                                                      weights = WEIGHT)
```

* 2019
```{r}
chile_2019$sexo <- factor(chile_2019$sex, labels = c("Hombre", "Mujer"))
chile_2019 <- chile_2019 %>% mutate_at(vars(starts_with(c("v", "brecha"))), ~(as.numeric(.))) 

chile_2019_exp <- chile_2019 %>% as_survey_design(ids = 1,
                                                      weights = WEIGHT)
```

## Tabla descriptivos

```{r}
descr_1999 <- chile_1999 %>% select(perc_doctor=V15,
                                    perc_gerente=V16,
                                    perc_tienda=V18,
                                    perc_obrero=V21,
                                    perc_ministro=V22,
                                    just_doctor=V25,
                                    just_gerente=V26,
                                    just_tienda=V28,
                                    just_obrero=V31,
                                    just_ministro=V32,
                                    brecha_perc=brecha_perc_1999, 
                                    brecha_just=brecha_just_1999,
                                    sexo,
                                    educacion_rec) %>% 
  cbind(year=c("1999"))

descr_1999$perc_doctor <- set_label(x = descr_1999$perc_doctor,label = "Salario Percibido: Doctor")
descr_1999$perc_gerente <- set_label(x = descr_1999$perc_gerente,label = "Salario Percibido: Gerente")
descr_1999$perc_tienda <- set_label(x = descr_1999$perc_tienda,label = "Salario Percibido: Asistente de tienda")
descr_1999$perc_obrero <- set_label(x = descr_1999$perc_obrero,label = "Salario Percibido: Obrero no calificado")
descr_1999$perc_ministro <- set_label(x = descr_1999$perc_ministro,label = "Salario Percibido: Ministro de gobierno")

descr_1999$just_doctor <- set_label(x = descr_1999$just_doctor,label = "Salario justo: Doctor")
descr_1999$just_gerente <- set_label(x = descr_1999$just_gerente,label = "Salario justo: Gerente")
descr_1999$just_tienda <- set_label(x = descr_1999$just_tienda,label = "Salario justo: Asistente de tienda")
descr_1999$just_obrero <- set_label(x = descr_1999$just_obrero,label = "Salario justo: Obrero no calificado")
descr_1999$just_ministro <- set_label(x = descr_1999$just_ministro,label = "Salario justo: Ministro de gobierno")

descr_1999$brecha_perc_1999 <- set_label(x = descr_1999$brecha_perc_1999,label = "Brecha salarial percibida")
descr_1999$brecha_just_1999 <- set_label(x = descr_1999$brecha_just_1999,label = "Brecha salarial justa")

descr_1999$educacion_rec <- set_label(x = descr_1999$educacion_rec,label = "Nivel educacional")
descr_1999$sexo <- set_label(x = descr_1999$sexo,label = "Sexo del entrevistado")


# 2009
descr_2009 <- chile_2009 %>% select(perc_doctor=V22,
                                    perc_gerente=V23,
                                    perc_tienda=V24,
                                    perc_obrero=V25,
                                    perc_ministro=V26,
                                    just_doctor=V27,
                                    just_gerente=V28,
                                    just_tienda=V29,
                                    just_obrero=V30,
                                    just_ministro=V31,
                                    brecha_perc=brecha_perc_2009, 
                                    brecha_just=brecha_just_2009,
                                    sexo,
                                    educacion_rec) %>% 
  cbind(year=c("2009"))

descr_2009$perc_doctor <- set_label(x = descr_2009$perc_doctor,label = "Salario Percibido: Doctor")
descr_2009$perc_gerente <- set_label(x = descr_2009$perc_gerente,label = "Salario Percibido: Gerente")
descr_2009$perc_tienda <- set_label(x = descr_2009$perc_tienda,label = "Salario Percibido: Asistente de tienda")
descr_2009$perc_obrero <- set_label(x = descr_2009$perc_obrero,label = "Salario Percibido: Obrero no calificado")
descr_2009$perc_ministro <- set_label(x = descr_2009$perc_ministro,label = "Salario Percibido: Ministro de gobierno")

descr_2009$just_doctor <- set_label(x = descr_2009$just_doctor,label = "Salario justo: Doctor")
descr_2009$just_gerente <- set_label(x = descr_2009$just_gerente,label = "Salario justo: Gerente")
descr_2009$just_tienda <- set_label(x = descr_2009$just_tienda,label = "Salario justo: Asistente de tienda")
descr_2009$just_obrero <- set_label(x = descr_2009$just_obrero,label = "Salario justo: Obrero no calificado")
descr_2009$just_ministro <- set_label(x = descr_2009$just_ministro,label = "Salario justo: Ministro de gobierno")

descr_2009$brecha_perc_2009 <- set_label(x = descr_2009$brecha_perc_2009,label = "Brecha salarial percibida")
descr_2009$brecha_just_2009 <- set_label(x = descr_2009$brecha_just_2009,label = "Brecha salarial justa")

descr_2009$educacion_rec <- set_label(x = descr_2009$educacion_rec,label = "Nivel educacional")
descr_2009$sexo <- set_label(x = descr_2009$sexo,label = "Sexo del entrevistado")

# 2019
descr_2019 <- chile_2019 %>% select(perc_doctor=v11,
                                    perc_gerente=v12,
                                    perc_tienda=v13,
                                    perc_obrero=v14,
                                    perc_ministro=v15,
                                    just_doctor=v16,
                                    just_gerente=v17,
                                    just_tienda=v18,
                                    just_obrero=v19,
                                    just_ministro=v20,
                                    brecha_perc=brecha_perc_2019, 
                                    brecha_just=brecha_just_2019,
                                    sexo,
                                    educacion_rec) %>% 
  cbind(year=c("2019"))

descr_2019$perc_doctor <- set_label(x = descr_2019$perc_doctor,label = "Salario Percibido: Doctor")
descr_2019$perc_gerente <- set_label(x = descr_2019$perc_gerente,label = "Salario Percibido: Gerente")
descr_2019$perc_tienda <- set_label(x = descr_2019$perc_tienda,label = "Salario Percibido: Asistente de tienda")
descr_2019$perc_obrero <- set_label(x = descr_2019$perc_obrero,label = "Salario Percibido: Obrero no calificado")
descr_2019$perc_ministro <- set_label(x = descr_2019$perc_ministro,label = "Salario Percibido: Ministro de gobierno")

descr_2019$just_doctor <- set_label(x = descr_2019$just_doctor,label = "Salario justo: Doctor")
descr_2019$just_gerente <- set_label(x = descr_2019$just_gerente,label = "Salario justo: Gerente")
descr_2019$just_tienda <- set_label(x = descr_2019$just_tienda,label = "Salario justo: Asistente de tienda")
descr_2019$just_obrero <- set_label(x = descr_2019$just_obrero,label = "Salario justo: Obrero no calificado")
descr_2019$just_ministro <- set_label(x = descr_2019$just_ministro,label = "Salario justo: Ministro de gobierno")

descr_2019$brecha_perc_2019 <- set_label(x = descr_2019$brecha_perc_2019,label = "Brecha salarial percibida")
descr_2019$brecha_just_2019 <- set_label(x = descr_2019$brecha_just_2019,label = "Brecha salarial justa")

descr_2019$educacion_rec <- set_label(x = descr_2019$educacion_rec,label = "Nivel educacional")
descr_2019$sexo <- set_label(x = descr_2019$sexo,label = "Sexo del entrevistado")
```

## Preparar boxplots

```{r}
boxplot <- rbind(descr_1999, descr_2009, descr_2019)

boxplot_perc <- boxplot %>% select(perc_doctor, perc_gerente, perc_tienda, perc_obrero, perc_ministro, year)

boxplot_perc <- boxplot_perc %>% 
  pivot_longer(cols = c("perc_doctor", 
                        "perc_gerente", 
                        "perc_tienda", 
                        "perc_obrero", 
                        "perc_ministro"), 
               names_to = "oficio",
               values_to = "value")

boxplot_perc$oficio <- factor(boxplot_perc$oficio,
                   levels = c("perc_obrero", 
                             "perc_tienda",
                             "perc_doctor", 
                             "perc_ministro",
                             "perc_gerente"),
                   labels = c("Obrero", 
                             "Asistente tienda",
                             "Doctor", 
                             "Ministro",
                             "Gerente"))


box_perc<-boxplot_perc %>%  ggplot(aes(x=oficio, y=value, pattern=year, fill=year)) + 
  geom_boxplot() +
  scale_y_continuous(name = "Ingreso", limits = c(0, 10000000))+
  scale_x_discrete(name="Oficio")+
  scale_fill_manual(values = c("white", "white", "grey"))+
   geom_boxplot_pattern(position = position_dodge(preserve = "single"), 
                        color = "black",
                        pattern_fill = "white",
                        pattern_density = 0.1, 
                        pattern_spacing = 0.025) +
   guides(pattern = guide_legend(override.aes = list(fill = c("white", "white", "grey"))))+
  scale_pattern_manual(values = c("1999" = "stripe", "2009" = "none", "2019" = "none"), guide = "Año") +
   labs(fill="Año",
        pattern="Año")+
  theme_bw()
 
box_perc
ggsave(box_perc, file="output/graphs/box_perc.png", width = 7,height = 7)
```

```{r}
boxplot_just <- boxplot %>% select(just_doctor, just_gerente, just_tienda, just_obrero, just_ministro, year)

boxplot_just <- boxplot_just %>% 
  pivot_longer(cols = c("just_doctor", 
                        "just_gerente", 
                        "just_tienda", 
                        "just_obrero", 
                        "just_ministro"), 
               names_to = "oficio",
               values_to = "value")

boxplot_just$oficio <- factor(boxplot_just$oficio,
                   levels = c("just_obrero", 
                             "just_tienda",
                             "just_doctor", 
                             "just_ministro",
                             "just_gerente"),
                   labels = c("Obrero", 
                             "Asistente tienda",
                             "Doctor", 
                             "Ministro",
                             "Gerente"))

box_just<-boxplot_just %>%  ggplot(aes(x=oficio, y=value, pattern=year, fill=year)) + 
  geom_boxplot() +
  scale_y_continuous(name = "Ingreso", limits = c(0, 10000000))+
  scale_x_discrete(name="Oficio")+
  scale_fill_manual(values = c("white", "white", "grey"))+
   geom_boxplot_pattern(position = position_dodge(preserve = "single"), 
                        color = "black",
                        pattern_fill = "white",
                        pattern_density = 0.1, 
                        pattern_spacing = 0.025) +
   guides(pattern = guide_legend(override.aes = list(fill = c("white", "white", "grey"))))+
  scale_pattern_manual(values = c("1999" = "stripe", "2009" = "none", "2019" = "none"), guide = "Año") +
   labs(fill="Año",
        pattern="Año")+
  theme_bw()

box_just
ggsave(box_just, file="output/graphs/box_just.png", width = 7,height = 7)
```

```{r}
boxplot_brecha <- boxplot %>% select(brecha_perc, brecha_just, year)

boxplot_brecha <- boxplot_brecha %>% 
  pivot_longer(cols = c("brecha_perc", 
                        "brecha_just"), 
               names_to = "brecha",
               values_to = "value")


box_brecha <- ggplot(boxplot_brecha, aes(x=brecha, y=value, pattern=year, fill=year)) + 
  geom_boxplot() +
  scale_y_continuous(name = "Tamaño de Brecha", limits = c(0, 150))+
  scale_x_discrete(name= "Tipo de Brecha",
                   label = c("Brecha justa",
                             "Brecha percibida"))+
  scale_fill_manual(values = c("white", "white", "grey"))+
   geom_boxplot_pattern(position = position_dodge(preserve = "single"), 
                        color = "black",
                        pattern_fill = "white",
                        pattern_density = 0.1, 
                        pattern_spacing = 0.025) +
   guides(pattern = guide_legend(override.aes = list(fill = c("white", "white", "grey"))))+
  scale_pattern_manual(values = c("1999" = "stripe", "2009" = "none", "2019" = "none"), guide = "Año") +
   labs(fill="Año",
        pattern="Año")+
  theme_bw()

box_brecha
ggsave(box_brecha, file="output/graphs/box_brecha.png", width = 7,height = 7)
```

### ajustar boxplot según inflación

```{r}
descr_1999_ipc <- descr_1999 %>% select(perc_doctor, perc_gerente, perc_tienda, perc_obrero, perc_ministro, year)

descr_1999_ipc <- descr_1999_ipc %>% 
  pivot_longer(cols = c("perc_doctor", 
                        "perc_gerente", 
                        "perc_tienda", 
                        "perc_obrero", 
                        "perc_ministro"), 
               names_to = "oficio",
               values_to = "value")

descr_1999_ipc$value <- descr_1999_ipc$value*1.88

descr_2009_ipc <- descr_2009 %>% select(perc_doctor, perc_gerente, perc_tienda, perc_obrero, perc_ministro, year)

descr_2009_ipc <- descr_2009_ipc %>% 
  pivot_longer(cols = c("perc_doctor", 
                        "perc_gerente", 
                        "perc_tienda", 
                        "perc_obrero", 
                        "perc_ministro"), 
               names_to = "oficio",
               values_to = "value")

descr_2009_ipc$value <- descr_2009_ipc$value*1.316

descr_2019_ipc <- descr_2019 %>% select(perc_doctor, perc_gerente, perc_tienda, perc_obrero, perc_ministro, year)
descr_2019_ipc <- descr_2019_ipc %>% 
  pivot_longer(cols = c("perc_doctor", 
                        "perc_gerente", 
                        "perc_tienda", 
                        "perc_obrero", 
                        "perc_ministro"), 
               names_to = "oficio",
               values_to = "value")
```


```{r}
boxplot_ipc <- rbind(descr_1999_ipc, descr_2009_ipc, descr_2019_ipc)
boxplot_perc_ipc <- boxplot_ipc 

boxplot_perc_ipc$oficio <- factor(boxplot_perc_ipc$oficio,
                   levels = c("perc_obrero", 
                             "perc_tienda",
                             "perc_doctor", 
                             "perc_ministro",
                             "perc_gerente"),
                   labels = c("Obrero", 
                             "Asistente tienda",
                             "Doctor", 
                             "Ministro",
                             "Gerente"))


box_perc_ipc<-boxplot_perc_ipc %>%  ggplot(aes(x=oficio, y=value, pattern=year, fill=year)) + 
  geom_boxplot() +
  scale_y_continuous(name = "Ingreso", limits = c(0, 10000000))+
  scale_x_discrete(name="Oficio")+
  scale_fill_manual(values = c("white", "white", "grey"))+
   geom_boxplot_pattern(position = position_dodge(preserve = "single"), 
                        color = "black",
                        pattern_fill = "white",
                        pattern_density = 0.1, 
                        pattern_spacing = 0.025) +
   guides(pattern = guide_legend(override.aes = list(fill = c("white", "white", "grey"))))+
  scale_pattern_manual(values = c("1999" = "stripe", "2009" = "none", "2019" = "none"), guide = "Año") +
   labs(fill="Año",
        pattern="Año")+
  theme_bw()
 
box_perc_ipc
ggsave(box_perc_ipc, file="output/graphs/box_perc_ipc.png", width = 7,height = 7)
```

```{r}
descr_1999_ipc <- descr_1999 %>% select(just_doctor, just_gerente, just_tienda, just_obrero, just_ministro, year)

descr_1999_ipc <- descr_1999_ipc %>% 
  pivot_longer(cols = c("just_doctor", 
                        "just_gerente", 
                        "just_tienda", 
                        "just_obrero", 
                        "just_ministro"), 
               names_to = "oficio",
               values_to = "value")

descr_1999_ipc$value <- descr_1999_ipc$value*1.88

descr_2009_ipc <- descr_2009 %>% select(just_doctor, just_gerente, just_tienda, just_obrero, just_ministro, year)

descr_2009_ipc <- descr_2009_ipc %>% 
  pivot_longer(cols = c("just_doctor", 
                        "just_gerente", 
                        "just_tienda", 
                        "just_obrero", 
                        "just_ministro"), 
               names_to = "oficio",
               values_to = "value")

descr_2009_ipc$value <- descr_2009_ipc$value*1.316

descr_2019_ipc <- descr_2019 %>% select(just_doctor, just_gerente, just_tienda, just_obrero, just_ministro, year)
descr_2019_ipc <- descr_2019_ipc %>% 
  pivot_longer(cols = c("just_doctor", 
                        "just_gerente", 
                        "just_tienda", 
                        "just_obrero", 
                        "just_ministro"), 
               names_to = "oficio",
               values_to = "value")
```


```{r}
boxplot_ipc <- rbind(descr_1999_ipc, descr_2009_ipc, descr_2019_ipc)
boxplot_just_ipc <- boxplot_ipc 

boxplot_just_ipc$oficio <- factor(boxplot_just_ipc$oficio,
                   levels = c("just_obrero", 
                             "just_tienda",
                             "just_doctor", 
                             "just_ministro",
                             "just_gerente"),
                   labels = c("Obrero", 
                             "Asistente tienda",
                             "Doctor", 
                             "Ministro",
                             "Gerente"))


box_just_ipc<-boxplot_just_ipc %>%  ggplot(aes(x=oficio, y=value, pattern=year, fill=year)) + 
  geom_boxplot() +
  scale_y_continuous(name = "Ingreso", limits = c(0, 10000000))+
  scale_x_discrete(name="Oficio")+
  scale_fill_manual(values = c("white", "white", "grey"))+
   geom_boxplot_pattern(position = position_dodge(preserve = "single"), 
                        color = "black",
                        pattern_fill = "white",
                        pattern_density = 0.1, 
                        pattern_spacing = 0.025) +
   guides(pattern = guide_legend(override.aes = list(fill = c("white", "white", "grey"))))+
  scale_pattern_manual(values = c("1999" = "stripe", "2009" = "none", "2019" = "none"), guide = "Año") +
   labs(fill="Año",
        pattern="Año")+
  theme_bw()
 
box_just_ipc
ggsave(box_just_ipc, file="output/graphs/box_just_ipc.png", width = 7,height = 7)
```



```{r}
df<- dfSummary(descr_1999_ipc,
               plain.ascii = FALSE,
               style = "grid",
               tmp.img.dir = "/tmp",
               graph.magnif = 0.75,
               headings = F,  # encabezado
               varnumbers = F, # num variable
               labels.col = T, # etiquetas
               na.col = T,    # missing
               graph.col = T, # plot
               valid.col = T, # n valido
               col.widths = c(1000,10,10,10,10,10))
df$Variable <- NULL # delete variable column
view(df,file = "output/tables/desc99.html")
webshot::webshot(url ="output/tables/desc99.html" ,file ="output/tables/desc99.png")
```

### Descriptivos

Salarios y brecha percibidos
```{r echo=FALSE}
tab1 <- read.csv(file = "input/table1.csv",header = 1,sep = ";",encoding = "UTF-8")

tab1 %>% 
knitr::kable("html", booktabs = T, linesep = "",col.names =  c("Variable", "Año", "Mínimo",  "Mediana", "Máximo", "Casos válidos", "Casos perdidos")) %>%
    kable_styling(bootstrap_options=c("striped", "hover", "condensed", "bordered"), full_width = F, font_size=14, position = "center", html_font = "Times new roman") %>% 
  column_spec(column = 1,width = "10em", bold = TRUE) %>%
  column_spec(column = 2,width = "3em") %>%
  column_spec(column = 3,width = "3em") %>%
  column_spec(column = 4,width = "3em") %>%
  column_spec(column = 5,width = "3em") %>%
  column_spec(column = 6,width = "3em") %>%
  column_spec(column = 7,width = "3em") %>% 
  collapse_rows(columns = 1) %>% 
  save_kable("output/tables/descriptivos_percibido.png", density=1000)
```

salarios y brecha justificadas
```{r echo=FALSE}
tab2 <- read.csv(file = "input/table2.csv",header = 1,sep = ";",encoding = "UTF-8")

tab2 %>% 
knitr::kable("html", booktabs = T, linesep = "",col.names =  c("Variable", "Año", "Mínimo",  "Mediana", "Máximo", "Casos válidos", "Casos perdidos")) %>%
    kable_styling(bootstrap_options=c("striped", "hover", "condensed", "bordered"), full_width = F, font_size=14, position = "center", html_font = "Times new roman") %>% 
  column_spec(column = 1,width = "10em", bold = TRUE) %>%
  column_spec(column = 2,width = "3em") %>%
  column_spec(column = 3,width = "3em") %>%
  column_spec(column = 4,width = "3em") %>%
  column_spec(column = 5,width = "3em") %>%
  column_spec(column = 6,width = "3em") %>%
  column_spec(column = 7,width = "3em") %>% 
  collapse_rows(columns = 1) %>% 
  save_kable("output/tables/descriptivos_justo.png", density=1000)
```

Salarios ipc y brecha percibidos
```{r echo=FALSE}
tab1_ipc <- read.csv(file = "input/table1-ipc.csv",header = 1,sep = ";",encoding = "UTF-8")

tab1_ipc %>% filter(Variable!= "Brecha salarial percibida") %>% 
knitr::kable("html", booktabs = T, linesep = "",col.names =  c("Variable", "Año", "Mediana", "Mediana ajustada", "Casos válidos")) %>%
    kable_styling(bootstrap_options=c("striped", "hover", "condensed", "bordered"), full_width = F, font_size=14, position = "center", html_font = "Times new roman") %>% 
  column_spec(column = 1,width = "10em", bold = TRUE) %>%
  column_spec(column = 2,width = "3em") %>%
  column_spec(column = 3,width = "3em") %>%
  column_spec(column = 4,width = "3em") %>%
  column_spec(column = 5,width = "3em") %>%
  collapse_rows(columns = 1) %>% 
  save_kable("output/tables/descriptivos_percibido_ipc.png", density=1000)
```

salarios ipc y brecha justificadas
```{r echo=FALSE}
tab2_ipc <- read.csv(file = "input/table2-ipc.csv",header = 1,sep = ";",encoding = "UTF-8")


tab2_ipc %>% filter(Variable!= "Brecha salarial justa") %>%  
knitr::kable("html", booktabs = T, linesep = "",col.names =  c("Variable", "Año", "Mediana", "Mediana ajustada", "Casos válidos")) %>%
    kable_styling(bootstrap_options=c("striped", "hover", "condensed", "bordered"), full_width = F, font_size=14, position = "center", html_font = "Times new roman") %>% 
  column_spec(column = 1,width = "10em", bold = TRUE) %>%
  column_spec(column = 2,width = "3em") %>%
  column_spec(column = 3,width = "3em") %>%
  column_spec(column = 4,width = "3em") %>%
  column_spec(column = 5,width = "3em") %>%
  collapse_rows(columns = 1) %>% 
  save_kable("output/tables/descriptivos_justo_ipc.png", density=1000)
```

## Estimar mediana de cada oficio según sexo, para los tres años de ISSP

```{r}
data_1999 <- chile_1999_exp %>% group_by(sexo) %>% 
  summarise(perc_doctor = survey_median(V15, vartype = "ci", na.rm = TRUE),
            perc_gerente = survey_median(V16, vartype = "ci", na.rm = TRUE),
            perc_tienda = survey_median(V18, vartype = "ci", na.rm = TRUE),
            perc_obrero = survey_median(V21, vartype = "ci", na.rm = TRUE),
            perc_ministro = survey_median(V22, vartype = "ci", na.rm = TRUE),
            just_doctor = survey_median(V25, vartype = "ci", na.rm = TRUE),
            just_gerente = survey_median(V26, vartype = "ci", na.rm = TRUE),
            just_tienda = survey_median(V28, vartype = "ci", na.rm = TRUE),
            just_obrero = survey_median(V31, vartype = "ci", na.rm = TRUE),
            just_ministro = survey_median(V32, vartype = "ci", na.rm = TRUE)) %>%
  cbind(year=c("1999")) %>% as.data.frame()

data_2009 <- chile_2009_exp %>% group_by(sexo) %>% 
  summarise(perc_doctor = survey_median(V22, vartype = "ci", na.rm = TRUE),
            perc_gerente = survey_median(V23, vartype = "ci", na.rm = TRUE),
            perc_tienda = survey_median(V24, vartype = "ci", na.rm = TRUE),
            perc_obrero = survey_median(V25, vartype = "ci", na.rm = TRUE),
            perc_ministro = survey_median(V26, vartype = "ci", na.rm = TRUE),
            just_doctor = survey_median(V27, vartype = "ci", na.rm = TRUE),
            just_gerente = survey_median(V28, vartype = "ci", na.rm = TRUE),
            just_tienda = survey_median(V29, vartype = "ci", na.rm = TRUE),
            just_obrero = survey_median(V30, vartype = "ci", na.rm = TRUE),
            just_ministro = survey_median(V31, vartype = "ci", na.rm = TRUE)) %>%
  cbind(year=c("2009")) %>% as.data.frame()

data_2019 <- chile_2019_exp %>% group_by(sexo) %>% 
  summarise(perc_doctor = survey_median(v11, vartype = "ci", na.rm = TRUE),
            perc_gerente = survey_median(v12, vartype = "ci", na.rm = TRUE),
            perc_tienda = survey_median(v13, vartype = "ci", na.rm = TRUE),
            perc_obrero = survey_median(v14, vartype = "ci", na.rm = TRUE),
            perc_ministro = survey_median(v15, vartype = "ci", na.rm = TRUE),
            just_doctor = survey_median(v16, vartype = "ci", na.rm = TRUE),
            just_gerente = survey_median(v17, vartype = "ci", na.rm = TRUE),
            just_tienda = survey_median(v18, vartype = "ci", na.rm = TRUE),
            just_obrero = survey_median(v19, vartype = "ci", na.rm = TRUE),
            just_ministro = survey_median(v20, vartype = "ci", na.rm = TRUE)) %>%
  cbind(year=c("2019")) %>% as.data.frame()
```

## Graficos

* Salario percibido

```{r}
perc_1999 <- data_1999 %>% 
  pivot_longer(cols = c("perc_doctor", 
                        "perc_gerente", 
                        "perc_tienda", 
                        "perc_obrero", 
                        "perc_ministro"),
               names_to = "oficio",
               values_to = "salario") %>% 
  select(sexo, year, oficio, salario)

perc_2009 <- data_2009 %>% 
  pivot_longer(cols = c("perc_doctor", 
                        "perc_gerente", 
                        "perc_tienda", 
                        "perc_obrero", 
                        "perc_ministro"), 
               names_to = "oficio",
               values_to = "salario") %>% 
  select(sexo, year, oficio, salario)

perc_2019 <- data_2019 %>% 
  pivot_longer(cols = c("perc_doctor", 
                        "perc_gerente", 
                        "perc_tienda", 
                        "perc_obrero", 
                        "perc_ministro"), 
               names_to = "oficio",
               values_to = "salario") %>% 
  select(sexo, year, oficio, salario)

salario_percibido <- rbind(perc_1999, perc_2009, perc_2019)
```


```{r}
salario_percibido$year <- as_factor(salario_percibido$year)
salario_percibido$oficio <- factor(salario_percibido$oficio, levels = c("perc_obrero", "perc_tienda", "perc_doctor", "perc_ministro", "perc_gerente"), labels = c("Obrero", "Asistente", "Doctor", "Ministro", "Gerente"))
salario_percibido$sexo <- factor(salario_percibido$sexo, levels = c("Mujer", "Hombre"))

plot_percibido <- salario_percibido %>%
  ggplot(aes(x=salario, y=oficio)) +
  theme_bw() +
  geom_point(aes(color = sexo, shape = sexo), size = 3) +
  xlab("salario percibido")+
  theme(axis.text.x = element_text(angle = 45, hjust = 1)) +
  scale_x_continuous(limits = c(0, 10000000),
                     breaks = seq(0, 10000000, by = 2000000)) +
  facet_grid(~year)

plot_percibido
ggsave(plot_percibido, file="output/graphs/issp_percibido_exp.png", width = 10,height = 7)
```

* Salario justo
```{r}
just_1999 <- data_1999 %>% 
  pivot_longer(cols = c("just_doctor", 
                        "just_gerente", 
                        "just_tienda", 
                        "just_obrero", 
                        "just_ministro"), 
               names_to = "oficio",
               values_to = "salario") %>% 
  select(sexo, year, oficio, salario)

just_2009 <- data_2009 %>% 
  pivot_longer(cols = c("just_doctor", 
                        "just_gerente", 
                        "just_tienda", 
                        "just_obrero", 
                        "just_ministro"), 
               names_to = "oficio",
               values_to = "salario") %>% 
  select(sexo, year, oficio, salario)

just_2019 <- data_2019 %>% 
  pivot_longer(cols = c("just_doctor", 
                        "just_gerente", 
                        "just_tienda", 
                        "just_obrero", 
                        "just_ministro"), 
               names_to = "oficio",
               values_to = "salario") %>% 
  select(sexo, year, oficio, salario)

salario_justo <- rbind(just_1999, just_2009, just_2019)
```

```{r}
salario_justo$year <- as_factor(salario_justo$year)
salario_justo$oficio <- factor(salario_justo$oficio, levels = c("just_obrero", "just_tienda", "just_doctor", "just_ministro", "just_gerente"), labels = c("Obrero", "Asistente", "Doctor", "Ministro", "Gerente"))
salario_justo$sexo <- factor(salario_justo$sexo, levels = c("Mujer", "Hombre"))

plot_justo <- salario_justo %>%
  ggplot(aes(salario, oficio)) +
  theme_bw() +
  geom_point(aes(color = sexo, shape = sexo), size = 3) +
  xlab("salario justo")+
  theme(axis.text.x = element_text(angle = 45, hjust = 1)) +
  scale_x_continuous(limits = c(0, 6000000),
                     breaks = seq(0, 6000000, by = 1500000)) +
  facet_grid(~year)

plot_justo
ggsave(plot_justo, file="output/graphs/issp_justo_exp.png", width = 10,height = 7)
```

### Brechas gerente/obrero

```{r}
brecha_1999 <- chile_1999_exp %>% group_by(sexo) %>%
  summarise(brecha_perc_1999 = survey_median(brecha_perc_1999, na.rm = T),
            brecha_just_1999 = survey_median(brecha_just_1999, na.rm = T)
            )

brecha_2009 <- chile_2009_exp %>% group_by(sexo) %>%
  summarise(brecha_perc_2009 = survey_median(brecha_perc_2009, na.rm = T),
            brecha_just_2009 = survey_median(brecha_just_2009, na.rm = T)
            )

brecha_2019 <- chile_2019_exp %>% group_by(sexo) %>%
  summarise(brecha_perc_2019 = survey_median(brecha_perc_2019, na.rm = T),
            brecha_just_2019 = survey_median(brecha_just_2019, na.rm = T)
            )
```

```{r}
base <- merge(brecha_1999, brecha_2009, by="sexo")
base <- merge(base, brecha_2019, by="sexo")

base <- base %>% 
  pivot_longer(cols = c("brecha_perc_1999", 
                        "brecha_just_1999", 
                        "brecha_perc_2009", 
                        "brecha_just_2009", 
                        "brecha_perc_2019", 
                        "brecha_just_2019"), 
               names_to = "year",
               values_to = "mean")
```

```{r}
base$year <- factor(base$year, levels = c("brecha_perc_1999", 
                        "brecha_just_1999", 
                        "brecha_perc_2009", 
                        "brecha_just_2009", 
                        "brecha_perc_2019", 
                        "brecha_just_2019"))
base$sexo <- factor(base$sexo, levels = c("Mujer", "Hombre"))

gerente_obrero <- ggplot(base, aes(x = year, y = mean, color=sexo)) +
  geom_point(size=4, aes(shape=sexo)) +
  labs(color = "Sexo", shape="Sexo") +
  xlab("") + ylab("Brecha")  +
  theme_bw() +
  theme(axis.text.x = element_text(angle = 30, hjust = 1)) +
  scale_x_discrete(label = c("Percibida 1999",
                             "Justa 1999", 
                             "Percibida 2009",  
                             "Justa 2009", 
                             "Percibida 2019",
                             "Justa 2019"))

gerente_obrero
ggsave(gerente_obrero, file="output/graphs/gerente_obrero_exp.png", width = 10, height = 7)
```

### brechas log(gerente/obrero)

```{r}
brecha_log_1999 <- chile_1999_exp %>% group_by(sexo) %>%
  summarise(brecha_perc_1999 = survey_median(brecha_perc_log_1999, na.rm = T),
            brecha_just_1999 = survey_median(brecha_just_log_1999, na.rm = T)
            )

brecha_log_2009 <- chile_2009_exp %>% group_by(sexo) %>%
  summarise(brecha_perc_2009 = survey_median(brecha_perc_log_2009, na.rm = T),
            brecha_just_2009 = survey_median(brecha_just_log_2009, na.rm = T)
            )

brecha_log_2019 <- chile_2019_exp %>% group_by(sexo) %>%
  summarise(brecha_perc_2019 = survey_median(brecha_perc_log_2019, na.rm = T),
            brecha_just_2019 = survey_median(brecha_just_log_2019, na.rm = T)
            )
```

```{r}
base_log <- merge(brecha_log_1999, brecha_log_2009, by="sexo")
base_log <- merge(base_log, brecha_log_2019, by="sexo")

base_log <- base_log %>% 
  pivot_longer(cols = c("brecha_perc_1999", 
                        "brecha_just_1999", 
                        "brecha_perc_2009", 
                        "brecha_just_2009", 
                        "brecha_perc_2019", 
                        "brecha_just_2019"), 
               names_to = "year",
               values_to = "mean")

```

```{r}
loggerente_obrero <- ggplot(base_log, aes(x = year, y = mean, color=sexo)) +
  geom_point(size=4, aes(shape=sexo)) +
  labs(color = "Sexo", shape="Sexo") +
  xlab("Año") + ylab("Brecha")  +
  theme_bw() +
  theme(axis.text.x = element_text(angle = 30, hjust = 1)) +
  scale_x_discrete(label = c("Percibida 1999",
                             "Justa 1999", 
                             "Percibida 2009",  
                             "Justa 2009", 
                             "Percibida 2019",
                             "Justa 2019"))

loggerente_obrero
ggsave(loggerente_obrero, file="output/graphs/loggerente_obrero_exp.png", width = 8, height = 5)
```

# Relación entre diferencias de ingreso, sexo y educación

### Brechas gerente/obrero

```{r}
brecha_educ_1999 <- chile_1999_exp %>% filter(!is.na(educacion_rec)) %>% 
  group_by(sexo, educacion_rec) %>%
  summarise(brecha_perc_1999 = survey_median(brecha_perc_1999, na.rm = T),
            brecha_just_1999 = survey_median(brecha_just_1999, na.rm = T)
            )

brecha_educ_2009 <- chile_2009_exp %>% filter(!is.na(educacion_rec)) %>% 
  group_by(sexo, educacion_rec) %>%
  summarise(brecha_perc_2009 = survey_median(brecha_perc_2009, na.rm = T),
            brecha_just_2009 = survey_median(brecha_just_2009, na.rm = T)
            )

brecha_educ_2019 <- chile_2019_exp %>% filter(!is.na(educacion_rec)) %>% 
  group_by(sexo, educacion_rec) %>%
  summarise(brecha_perc_2019 = survey_median(brecha_perc_2019, na.rm = T),
            brecha_just_2019 = survey_median(brecha_just_2019, na.rm = T)
            )
```

```{r}
base_educ <- merge(brecha_educ_1999, brecha_educ_2009, by=c("sexo", "educacion_rec"))
base_educ <- merge(base_educ, brecha_educ_2019, by=c("sexo", "educacion_rec"))

base_educ <- base_educ %>% 
  pivot_longer(cols = c("brecha_perc_1999", 
                        "brecha_just_1999", 
                        "brecha_perc_2009", 
                        "brecha_just_2009", 
                        "brecha_perc_2019", 
                        "brecha_just_2019"), 
               names_to = "year",
               values_to = "mean")
```

```{r}
base_educ$year <- factor(base_educ$year, levels = c("brecha_perc_1999", 
                        "brecha_just_1999", 
                        "brecha_perc_2009", 
                        "brecha_just_2009", 
                        "brecha_perc_2019", 
                        "brecha_just_2019"))
base_educ$sexo <- factor(base_educ$sexo, levels = c("Mujer", "Hombre"))

gerente_obrero_educ <- ggplot(base_educ, aes(x = year, y = mean, color=sexo)) +
  geom_point(size=4, aes(shape=sexo)) +
  labs(color = "Sexo", shape="Sexo") +
  xlab("") + ylab("Brecha")  +
  theme_bw() +
  theme(axis.text.x = element_text(angle = 50, hjust = 1)) +
  scale_x_discrete(label = c("Percibida 1999",
                             "Justa 1999", 
                             "Percibida 2009",  
                             "Justa 2009", 
                             "Percibida 2019",
                             "Justa 2019"))+
  facet_wrap(~educacion_rec)

gerente_obrero_educ
ggsave(gerente_obrero_educ, file="output/graphs/gerente_obrero_educ_exp.png", width = 12,height = 6)
```

# Comparación internacional

```{r}
load("input/proc/inter_1999.RData")
load("input/proc/inter_2009.RData")
load("input/proc/inter_2019.RData")
```

## Ponderadores

* 1999
```{r}
inter_1999 <- inter_1999 %>% mutate_at(vars(starts_with(c("V", "brecha"))), ~(as.numeric(.))) 

inter_1999_exp <- inter_1999 %>% as_survey_design(ids = 1,
                                                      weights = WEIGHT)
```

* 2009
```{r}
inter_2009 <- inter_2009 %>% mutate_at(vars(starts_with(c("V", "brecha"))), ~(as.numeric(.))) 

inter_2009_exp <- inter_2009 %>% as_survey_design(ids = 1,
                                                      weights = WEIGHT)
```

* 2019
```{r}
inter_2019 <- inter_2019 %>% mutate_at(vars(starts_with(c("v", "brecha"))), ~(as.numeric(.))) 

inter_2019_exp <- inter_2019 %>% as_survey_design(ids = 1,
                                                      weights = WEIGHT)
```

## Estimacion

### 1999
```{r}
brecha_pais_1999 <- inter_1999_exp %>% filter(!is.na(sex)) %>% 
  group_by(sex, pais) %>%
  summarise(brecha_perc_1999 = survey_median(brecha_perc_1999, na.rm = T),
            brecha_just_1999 = survey_median(brecha_just_1999, na.rm = T)
            ) %>%
  arrange(brecha_perc_1999)

inter_1999$pais <- factor(inter_1999$pais, labels = c("AUS Australia", "D-W Germany West", "D-E Germany East", "GB Great Britain", "NIRL North Ireland", "USA United States", "A Austria", "H Hungary", "N Norway", "S Sweden", "CZ Czech Rep", "SLO Slovenia", "PL Poland", "BG Bulgaria", "RUS Russia", "NZ New Zealand", "CDN Canada", "RP Philippines", "IL Israel", "J Japan", "E Spain", "LV Latvia", "F France", "CY Cyprus", "P Portugal", "RCH Chile", "SVK Slovakia"))

get_labels(inter_1999$pais)

brecha_pais_1999$pais <- factor(brecha_pais_1999$pais, labels = get_labels(inter_1999$pais))

brecha_hombre_pais <- brecha_pais_1999 %>% filter(sex==1) %>%
    mutate(pais = factor(pais, levels = .$pais))

brecha_mujer_pais <- brecha_pais_1999 %>% filter(sex==2) %>%
    mutate(pais = factor(pais, levels = .$pais))

brecha_hombre_pais <- brecha_hombre_pais[order(brecha_hombre_pais$brecha_perc_1999), ]
brecha_mujer_pais <- brecha_mujer_pais[order(brecha_mujer_pais$brecha_perc_1999), ]

brecha_hombre_1999 <- brecha_hombre_pais %>% 
  pivot_longer(cols = c("brecha_perc_1999", 
                        "brecha_just_1999"), 
               names_to = "year",
               values_to = "mean")

brecha_mujer_1999 <- brecha_mujer_pais %>% 
  pivot_longer(cols = c("brecha_perc_1999", 
                        "brecha_just_1999"), 
               names_to = "year",
               values_to = "mean")

brecha_1999 <- rbind(brecha_hombre_1999, brecha_mujer_1999)
class(brecha_1999$sex)
brecha_1999$sex <- as_factor(brecha_1999$sex)
```

* 2009
```{r}
brecha_pais_2009 <- inter_2009_exp %>% filter(!is.na(sex)) %>% 
  group_by(sex, pais) %>%
  summarise(brecha_perc_2009 = survey_median(brecha_perc_2009, na.rm = T),
            brecha_just_2009 = survey_median(brecha_just_2009, na.rm = T)
            ) %>%
  arrange(brecha_perc_2009)
brecha_pais_2009$pais <- factor(brecha_pais_2009$pais, labels = get_labels(inter_2009$pais))

brecha_pais_2009$pais <- if_else(brecha_pais_2009$pais=="GB-Great Britain and/or United Kingdom", "GB-Great Britain", as.character(brecha_pais_2009$pais))

brecha_hombre_pais <- brecha_pais_2009 %>% filter(sex==1) %>%
    mutate(pais = factor(pais, levels = .$pais))

brecha_mujer_pais <- brecha_pais_2009 %>% filter(sex==2) %>%
    mutate(pais = factor(pais, levels = .$pais))

brecha_hombre_pais <- brecha_hombre_pais[order(brecha_hombre_pais$brecha_perc_2009), ]
brecha_mujer_pais <- brecha_mujer_pais[order(brecha_mujer_pais$brecha_perc_2009), ]

brecha_hombre_2009 <- brecha_hombre_pais %>% 
  pivot_longer(cols = c("brecha_perc_2009", 
                        "brecha_just_2009"), 
               names_to = "year",
               values_to = "mean")

brecha_mujer_2009 <- brecha_mujer_pais %>% 
  pivot_longer(cols = c("brecha_perc_2009", 
                        "brecha_just_2009"), 
               names_to = "year",
               values_to = "mean")

brecha_2009 <- rbind(brecha_hombre_2009, brecha_mujer_2009)
class(brecha_2009$sex)
brecha_2009$sex <- as_factor(brecha_2009$sex)
```

### 2019
```{r}
brecha_pais_2019 <- inter_2019_exp %>% filter(!is.na(sex)) %>% 
  group_by(sex, pais) %>%
  summarise(brecha_perc_2019 = survey_median(brecha_perc_2019, na.rm = T),
            brecha_just_2019 = survey_median(brecha_just_2019, na.rm = T)
            ) %>%
  arrange(brecha_perc_2019)

brecha_pais_2019$pais <- factor(brecha_pais_2019$pais, labels = get_labels(inter_2019$pais))

brecha_hombre_pais <- brecha_pais_2019 %>% filter(sex==1) %>%
    mutate(pais = factor(pais, levels = .$pais))

brecha_mujer_pais <- brecha_pais_2019 %>% filter(sex==2) %>%
    mutate(pais = factor(pais, levels = .$pais))

brecha_hombre_pais <- brecha_hombre_pais[order(brecha_hombre_pais$brecha_perc_2019), ]
brecha_mujer_pais <- brecha_mujer_pais[order(brecha_mujer_pais$brecha_perc_2019), ]

brecha_hombre_2019 <- brecha_hombre_pais %>% 
  pivot_longer(cols = c("brecha_perc_2019", 
                        "brecha_just_2019"), 
               names_to = "year",
               values_to = "mean")

brecha_mujer_2019 <- brecha_mujer_pais %>% 
  pivot_longer(cols = c("brecha_perc_2019", 
                        "brecha_just_2019"), 
               names_to = "year",
               values_to = "mean")

brecha_2019 <- rbind(brecha_hombre_2019, brecha_mujer_2019)
class(brecha_2019$sex)
brecha_2019$sex <- as_factor(brecha_2019$sex)
```

## Brecha percibida

### Cleveland 2019

```{r}
get_labels(brecha_2019$pais)
brecha_2019$pais <- factor(brecha_2019$pais, labels = c("Norway", "Denmark", "Sweden", "Bulgaria", "Philippines", "Croatia", "Czech Republic", "Iceland", "Lithuania", "Israel", "Italy", "Finland", "Thailand", "Slovenia", "Great Britain", "Japan", "New Zealand", "Suriname", "Switzerland", "Austria", "South Africa", "Venezuela", "Taiwan", "France", "Australia", "Chile", "Germany", "United States", "Russia"))

brecha_2019_ord <- arrange(brecha_2019, mean)
brecha_2019_ord$sex <- factor(brecha_2019_ord$sex, levels = c("2. Female", "1. Male"), labels = c("Mujer", "Hombre"))

cleveland_2019 <- brecha_2019_ord %>% filter(year=="brecha_perc_2019") %>% 
  ggplot(aes(mean, pais)) +
  theme_bw() +
  geom_point(aes(color = sex, shape = sex), size = 3) +
  xlab("Brecha percibida") +
  xlim(0,50) +
  labs(colour = "Sexo", shape="Sexo") + 
  theme(axis.text.y = element_text(colour = c(rep("black", 25), "red", rep("black", 3))),
        legend.position = "right") 

cleveland_2019
ggsave(cleveland_2019, file="output/graphs/cleveland2019_percibida.png", width = 7,height = 7)
```

### Scatterplot brecha percibida vs objetiva (WEF)

```{r}
diferencia <- brecha_2019 %>% select(sex, pais, year, mean) %>% 
  filter(year=="brecha_perc_2019") %>% 
  pivot_wider(names_from = "sex",
              values_from = "mean") %>% 
  rename("Hombre"="1. Male",
         "Mujer" = "2. Female") %>% 
  group_by(pais) %>% 
  mutate(diferencia = Hombre-Mujer,
         brecha = round((diferencia/Mujer),3))

brecha_objetiva <- 1-c(0.842, 0.782, 0.820, 0.727, 0.781, 0.720, 0.706, 0.877, 0.745, 0.718, 0.707, 0.832, 0.708, 0.743, 0.767, 0.652, 0.799, 0.707, 0.779, 0.744, 0.780, 0.713, NA, 0.781, 0.731, 0.723, 0.787, 0.724, 0.706)
diferencia <- cbind(diferencia, as.data.frame(brecha_objetiva))
```

```{r}
scatterplot_percibida <- ggplot(diferencia, aes(x = brecha_objetiva, y = brecha)) +
  geom_point()+
  geom_smooth(method = "lm") +
  geom_text_repel(aes(label=pais), size = 4) +
  xlab("Brecha objetiva") +
  ylab("Diferencia salarial percibida por género")+
  theme_bw()

scatterplot_percibida

ggsave(scatterplot_percibida, file="output/graphs/scatterplot_percibida_WEF.png", width = 7,height = 7)
```

### Scatterplot brecha percibida vs objetiva (OCDE)

```{r}
diferencia <- brecha_2019 %>% select(sex, pais, year, mean) %>% 
  filter(year=="brecha_perc_2019") %>% 
  pivot_wider(names_from = "sex",
              values_from = "mean") %>% 
  rename("Hombre"="1. Male",
         "Mujer" = "2. Female") %>% 
  group_by(pais) %>% 
  mutate(diferencia = Hombre-Mujer,
         brecha = round((diferencia/Hombre),3)*100)

brecha_objetiva <- c(4.368, 5.059, 7.576, 3.358, NA, 7.575, 14.714, 12.901, 14.071, 24.319, 7.640, 17.160, NA, 8.195, 16.100, 23.480, 6.508, NA, 15.096, 14.012, NA, NA, NA, 14.098, 15.312, 8.596, 13.987, 18.471, NA)
diferencia <- cbind(diferencia, as.data.frame(brecha_objetiva))
```

```{r}
scatterplot_percibida <- ggplot(diferencia, aes(x = brecha_objetiva, y = brecha)) +
  geom_point()+
  geom_smooth(method = "lm") +
  geom_text_repel(aes(label=pais), size = 4) +
  xlab("Brecha objetiva") +
  ylab("Diferencia salarial percibida por género")+
  theme_bw()

scatterplot_percibida

cor(diferencia$brecha, diferencia$brecha_objetiva)

ggsave(scatterplot_percibida, file="output/graphs/scatterplot_percibida_OCDE.png", width = 7, height = 7)
```

### Cleveland con los tres años

```{r}
get_labels(brecha_1999$pais)
brecha_1999$pais <- factor(brecha_1999$pais, labels = c("Norway", "Cyprus", "Spain", "Sweden", "Philippines", "Slovakia", "Bulgaria", "Austria", "Germany West", "Israel", "Germany East", "North Ireland", "Australia", "United States", "New Zealand", "Japan", "Portugal", "Slovenia", "Czech Republic", "Canada", "Great Britain", "Hungary", "Poland", "France", "Latvia", "Chile", "Russia"))

germany <- brecha_1999 %>% filter(pais=="Germany West" | pais=="Germany East") %>% group_by(sex, year) %>% summarise(mean=mean(mean)) %>% cbind(pais=c("Germany"))

brecha_1999 <- rbind(
  filter(brecha_1999, pais!="Germany West" & pais!="Germany East"),
  germany
  )


get_labels(brecha_2009$pais)
brecha_2009$pais <- factor(brecha_2009$pais, labels = c("Denmark", "Philippines", "Norway", "Sweden", "Belgium", "Venezuela", "Argentina", "Cyprus", "Bulgaria", "Iceland", "Spain", "Israel", "Slovakia", "Latvia", "Turkey", "Japan", "Croatia", "Czech Republic", "New Zealand", "China", "Estonia", "Finland", "Lithuania", "Austria", "Poland", "Switzerland", "Ukraine", "Italy", "South Africa", "Portugal", "Slovenia", "Great Britain", "Russia", "Germany", "Hungary", "France", "Taiwan", "Chile", "Australia", "United States", "South Korea"))

get_labels(brecha_2019$pais)

get_labels(brecha_2019$sex)
brecha_2019$sex <- factor(brecha_2019$sex, labels = c("Male", "Female"))

brecha_inter <- rbind(select(brecha_1999, sex, pais, year, mean), 
                      select(brecha_2009, sex, pais, year, mean), 
                      select(brecha_2019, sex, pais, year, mean))

brecha_inter <- brecha_inter %>%
  filter(year=="brecha_perc_1999" | year=="brecha_perc_2009" | year=="brecha_perc_2019") %>% 
  pivot_wider(names_from = "sex",
              values_from = "mean") %>% 
  rename("Hombre"= "Male",
         "Mujer" = "Female") %>% 
  group_by(pais) %>% 
  mutate(diferencia = Hombre-Mujer,
         brecha = round((diferencia/Hombre),3)*100)
```

```{r}
pais <- brecha_inter %>% group_by(pais) %>% summarize(brecha=mean(brecha)) %>%
   arrange(brecha)
brecha_inter$pais <- factor(brecha_inter$pais, levels = pais$pais)


cleveland_inter_year <- brecha_inter %>% filter(pais %nin% c("South Korea", "Canada", "Ukraine", "Finland", "Switzerland", "Portugal", "Italy", "Venezuela", "Poland", "Estonia", "Turkey", "Belgium", "North Ireland", "Latvia", "South Africa", "Hungary", "Croatia", "Spain", "Taiwan", "Denmark", "Iceland", "Cyprus", "Slovakia", "Argentina", "China", "Suriname", "Thailand", "Lithuania")) %>% 
  ggplot(aes(brecha, pais)) +
  theme_bw() +
  geom_point(aes(color = year, shape = year), size = 3) +
  xlab("Diferencia salarial percibida por género")+
  xlim(-50,50) +
  labs(colour = "Año", shape="Año")  +
  scale_color_discrete(labels = c('1999','2009', '2019'))+
  scale_shape_discrete(labels = c('1999','2009', '2019'))+
  theme(axis.text.y = element_text(colour = c(rep("black", 10), "red", rep("black", 6))),
        legend.position = "right") 

cleveland_inter_year
ggsave(cleveland_inter_year, file="output/graphs/cleveland_inter_year_perc.png", width = 7,height = 7)
```

## Brecha justa

### Cleveland 2019

```{r}
pais <- brecha_2019 %>% filter(year=="brecha_just_2019" & sex=="Male") %>% 
  arrange(mean)

brecha_2019_just <- brecha_2019

brecha_2019_just$pais <- factor(brecha_2019$pais, levels = pais$pais)

brecha_2019_just$sex <- factor(brecha_2019_just$sex, levels = c("Female", "Male"), labels = c("Mujer", "Hombre"))

cleveland_2019 <- brecha_2019_just %>% filter(year=="brecha_just_2019") %>% 
  ggplot(aes(mean, pais)) +
  theme_bw() +
  geom_point(aes(color = sex, shape = sex), size = 3) +
  xlab("Brecha justa") +
  xlim(0,50) +
  labs(colour = "Sexo", shape="Sexo") + 
  theme(axis.text.y = element_text(colour = c(rep("black", 23), "red", rep("black", 5))),
        legend.position = "right") 

cleveland_2019
ggsave(cleveland_2019, file="output/graphs/cleveland2019_justa.png", width = 7,height = 7)
```

### Scatterplot brecha percibida vs objetiva (WEF)

```{r}
diferencia <- brecha_2019 %>% select(sex, pais, year, mean) %>% 
  filter(year=="brecha_just_2019") %>% 
  pivot_wider(names_from = "sex",
              values_from = "mean") %>% 
  rename("Hombre"="Male",
         "Mujer" ="Female") %>% 
  group_by(pais) %>% 
  mutate(diferencia = Hombre-Mujer,
         brecha = round((diferencia/Mujer),3))

brecha_objetiva <- 1-c(0.842, 0.782, 0.820, 0.727, 0.781, 0.720, 0.706, 0.877, 0.745, 0.718, 0.707, 0.832, 0.708, 0.743, 0.767, 0.652, 0.799, 0.707, 0.779, 0.744, 0.780, 0.713, NA, 0.781, 0.731, 0.723, 0.787, 0.724, 0.706)
diferencia <- cbind(diferencia, as.data.frame(brecha_objetiva))
```

```{r}
scatterplot_justa <- ggplot(diferencia, aes(x = brecha_objetiva, y = brecha)) +
  geom_point()+
  geom_smooth(method = "lm") +
  geom_text_repel(aes(label=pais), size = 4) +
  xlab("Brecha objetiva") +
  ylab("Diferencia salarial justa por género")+
  theme_bw()

scatterplot_justa

ggsave(scatterplot_justa, file="output/graphs/scatterplot_justa_WEF.png", width = 10,height = 7)
```

### Scatterplot brecha percibida vs objetiva (OCDE)

```{r}
diferencia <- brecha_2019 %>% select(sex, pais, year, mean) %>% 
  filter(year=="brecha_just_2019") %>% 
  pivot_wider(names_from = "sex",
              values_from = "mean") %>% 
  rename("Hombre"="Male",
         "Mujer" = "Female") %>% 
  group_by(pais) %>% 
  mutate(diferencia = Hombre-Mujer,
         brecha = round((diferencia/Hombre),3)*100)

brecha_objetiva <- c(4.368, 5.059, 7.576, 3.358, NA, 7.575, 14.714, 12.901, 14.071, 24.319, 7.640, 17.160, NA, 8.195, 16.100, 23.480, 6.508, NA, 15.096, 14.012, NA, NA, NA, 14.098, 15.312, 8.596, 13.987, 18.471, NA)
diferencia <- cbind(diferencia, as.data.frame(brecha_objetiva))
```

```{r}
scatterplot_justa <- ggplot(diferencia, aes(x = brecha_objetiva, y = brecha)) +
  geom_point()+
  geom_smooth(method = "lm") +
  geom_text_repel(aes(label=pais), size = 4) +
  xlab("Brecha objetiva") +
  ylab("Diferencia salarial justa por género")+
  theme_bw()

scatterplot_justa

ggsave(scatterplot_justa, file="output/graphs/scatterplot_justa_OCDE.png", width = 7, height = 7)
```

### Cleveland con los tres años

```{r}
brecha_inter <- rbind(select(brecha_1999, sex, pais, year, mean), 
                      select(brecha_2009, sex, pais, year, mean), 
                      select(brecha_2019, sex, pais, year, mean))

brecha_inter <- brecha_inter %>%
  filter(year=="brecha_just_1999" | year=="brecha_just_2009" | year=="brecha_just_2019") %>% 
  pivot_wider(names_from = "sex",
              values_from = "mean") %>% 
  rename("Hombre"= "Male",
         "Mujer" = "Female") %>% 
  group_by(pais) %>% 
  mutate(diferencia = Hombre-Mujer,
         brecha = round((diferencia/Hombre),3)*100)
```

```{r}
pais <- brecha_inter %>% group_by(pais) %>% summarize(brecha=mean(brecha)) %>%
   arrange(brecha)
brecha_inter$pais <- factor(brecha_inter$pais, levels = pais$pais)


cleveland_inter_year <- brecha_inter %>% filter(pais %nin% c("South Korea", "Canada", "Ukraine", "Finland", "Switzerland", "Portugal", "Italy", "Venezuela", "Poland", "Estonia", "Turkey", "Belgium", "North Ireland", "Latvia", "South Africa", "Hungary", "Croatia", "Spain", "Taiwan", "Denmark", "Iceland", "Cyprus", "Slovakia", "Argentina", "China", "Suriname", "Thailand", "Lithuania")) %>% 
  ggplot(aes(brecha, pais)) +
  theme_bw() +
  geom_point(aes(color = year, shape = year), size = 3) +
  xlab("Diferencia salarial justa por género")+
  xlim(-50,50) +
  labs(colour = "Año", shape="Año")  +
  scale_color_discrete(labels = c('1999','2009', '2019'))+
  scale_shape_discrete(labels = c('1999','2009', '2019'))+
  theme(axis.text.y = element_text(colour = c(rep("black", 11), "red", rep("black", 5))),
        legend.position = "right") 

cleveland_inter_year
ggsave(cleveland_inter_year, file="output/graphs/cleveland_inter_year_just.png", width = 7,height = 7)
```

# Regresiones

* 1999

```{r}
data3 <- chile_1999 %>% 
  dplyr::select(sex, 
                educacion_rec, 
                brecha_perc=brecha_perc_1999, 
                brecha_just=brecha_just_1999) %>%
  cbind(year=c("1999")) %>% as.data.frame()

data3 <- na.omit(data3)
data3$sex <- factor(data3$sex, labels = c("Hombre", "Mujer"))
```

* 2009

```{r}
data2 <- chile_2009 %>% 
  dplyr::select(sex, 
                educacion_rec, 
                brecha_perc=brecha_perc_2009, 
                brecha_just=brecha_just_2009) %>%
  cbind(year=c("2009")) %>% as.data.frame()
data2 <- na.omit(data2)
data2$sex <- factor(data2$sex, labels = c("Hombre", "Mujer"))
```

* 2019

```{r}
data <- chile_2019 %>% 
  dplyr::select(sex, 
                educacion_rec, 
                brecha_perc=brecha_perc_2019, 
                brecha_just=brecha_just_2019) %>%
  cbind(year=c("2019")) %>% as.data.frame()
data <- na.omit(data)
data$sex <- factor(data$sex, labels = c("Hombre", "Mujer"))
```

```{r}
dat <- rbind(data, data2, data3)
```

```{r}
install.packages("quantreg")
library(quantreg)
```

```{r}
ls_fl_quantiles <- c(0.25, 0.50, 0.75)
fit_quantiles <- rq(brecha_perc ~ sex,
               tau = ls_fl_quantiles,
               data = dat)
reg1 <- rq(brecha_perc ~ sex, data=dat)
reg2 <- rq(brecha_perc ~ sex + educacion_rec, data=dat)
reg3 <- rq(brecha_perc ~ sex + educacion_rec + year, data=dat)
#reg4 <- lm(brecha_perc ~ sex*educacion_rec + year, data=dat)
reg5 <- rq(brecha_just ~ sex, data=dat)
reg6 <- rq(brecha_just ~ sex + educacion_rec, data=dat)
reg7 <- rq(brecha_just ~ sex + educacion_rec + year, data=dat)
reg8 <- rq(brecha_just ~ sex + educacion_rec + year + brecha_perc, data=dat)

screenreg(list(reg1, reg2, reg3, reg5, reg6, reg7, reg8))
```



```{r}
htmlreg(list(reg1, reg2, reg3, reg5, reg6, reg7, reg8),
        custom.header = list("Brecha percibida"=1:3, "Brecha justa"=4:7),
        custom.model.names = c("Modelo 1",
                               "Modelo 2",
                               "Modelo 3",
                               "Modelo 4",
                               "Modelo 5",
                               "Modelo 6",
                               "Modelo 7"),
        doctype = FALSE,
        custom.note = "*** p < 0.001; ** p < 0.01; * p < 0.05", 
        custom.coef.names = c("Intercepto", 
                              "Mujer <br> <i>(Ref. Hombre)</i>",
                              "Ed. media completa <br> <i>(Ref. Ed. media incompleta)</i>",
                              "Educación universitaria",
                              "2009 <br> <i>(Ref. año 1999)</i>",
                              "2019",
                              "Brecha percibida"),
        caption = "Percepción de brechas",
        caption.above = TRUE,
        file = "output/tables/reg_brechas.html")

webshot2::webshot(url ="output/tables/reg_brechas.html" ,file ="output/tables/reg_brechas.png",)
```


